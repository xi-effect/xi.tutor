# Синхронизация доски в ВКС - Описание кейсов

Документ описывает все сценарии работы с доской в режиме совместной работы (collaborative mode) в модуле ВКС.

## Общая архитектура

- **DataChannel**: Используется для синхронизации состояния между участниками через LiveKit
- **Zustand Store**: Локальное хранилище состояния (`useCallStore`)
- **Ключевые поля в store**:
  - `mode`: `'compact' | 'full'` - режим отображения ВКС
  - `activeBoardId`: `string | undefined` - ID активной доски
  - `activeClassroom`: `string | undefined` - ID класса (callId)

## Кейсы со стороны репетитора

### 1. Репетитор включает collaborative mode и выбирает доску

**Действия:**

1. Репетитор открывает модальное окно выбора доски (`WhiteboardsModal`)
2. Выбирает доску и оставляет чекбокс "collaborative mode" включенным
3. Нажимает "Подтвердить"

**Что происходит:**

- Обновляется локальный `mode` на `'compact'`
- Сохраняются `activeBoardId` и `activeClassroom` в store
- Отправляется сообщение `mode_sync` всем участникам через DataChannel
- Репетитор переходит на страницу доски с параметром `?call=<callId>`
- Все подключенные участники получают сообщение и автоматически переключаются на доску

**Файлы:**

- `src/ui/Bottom/WhiteboardsModal.tsx` - `handleConfirm`
- `src/hooks/useModeSync.ts` - `syncModeToOthers`

---

### 2. Репетитор переключается на full view с доски

**Действия:**

1. Репетитор на доске в compact mode
2. Нажимает кнопку "Вернуться в конференцию" в `CompactCall`
3. Выбирает один из вариантов в Dropdown:
   - **"Только мне"** - переключиться только репетитору
   - **"Всем участникам"** - переключить всех участников на full view

**Что происходит:**

#### Вариант "Только мне":

- Локальный `mode` обновляется на `'full'`
- `activeBoardId` и `activeClassroom` **НЕ очищаются** (для возможности вернуться)
- Отправляется сообщение `mode_sync` с `mode: 'full'` всем участникам
- Репетитор переходит на страницу конференции `/call/<callId>` с параметром `?call=<callId>`
- **Важно**: Другие участники, которые находятся на доске, **игнорируют** это сообщение (не переключаются на full)

#### Вариант "Всем участникам":

- Локальный `mode` обновляется на `'full'`
- `activeBoardId` и `activeClassroom` **очищаются** (репетитор завершает работу с доской для всех)
- Отправляется сообщение `mode_sync` с `mode: 'full'` всем участникам
- Все участники получают сообщение и переключаются на full view (даже те, кто был на доске)
- Репетитор переходит на страницу конференции `/call/<callId>` с параметром `?call=<callId>`

**Файлы:**

- `src/ui/CompactView/CompactCall.tsx` - `handleMaximize` (параметр `syncToAll`)
- `src/hooks/useModeSync.ts` - `handleModeSyncMessage` (проверка `currentActiveBoardId`)

---

### 3. Репетитор возвращается на доску из full view

**Действия:**

1. Репетитор в full view, но `activeBoardId` и `activeClassroom` сохранены в store
2. Нажимает кнопку "К доске" в `BottomBar`

**Что происходит:**

- Локальный `mode` обновляется на `'compact'`
- Отправляется сообщение `mode_sync` с `mode: 'compact'` и `boardId` всем участникам
- Репетитор переходит на страницу доски с параметром `?call=<callId>`
- Все участники получают сообщение и переключаются на доску (если они в full mode)

**Файлы:**

- `src/ui/Bottom/BottomBar.tsx` - `handleBackToBoard`
- `src/hooks/useModeSync.ts` - `syncModeToOthers`

---

### 4. Репетитор переключается на другую доску

**Действия:**

1. Репетитор на доске A в compact mode
2. Открывает модальное окно и выбирает доску B

**Что происходит:**

- Обновляется `activeBoardId` на ID доски B
- Отправляется сообщение `mode_sync` с новым `boardId` всем участникам
- Репетитор переходит на доску B
- Все участники получают сообщение и переключаются на доску B

**Файлы:**

- `src/ui/Bottom/WhiteboardsModal.tsx` - `handleConfirm`
- `src/hooks/useModeSync.ts` - `syncModeToOthers`

---

### 5. Репетитор отключается от ВКС

**Действия:**

1. Репетитор нажимает "Отключиться"

**Что происходит:**

- Очищаются `activeBoardId` и `activeClassroom` в store
- Очищается параметр `call` из URL
- Все состояния интерфейса сбрасываются

**Файлы:**

- `src/providers/LiveKitProvider.tsx` - `handleDisconnect`
- `src/ui/CompactView/CompactView.tsx` - `useEffect` для очистки

---

## Кейсы со стороны студента

### 1. Студент заходит в ВКС, когда репетитор уже на доске

**Действия:**

1. Студент подключается к ВКС
2. Репетитор уже в compact mode на доске

**Что происходит:**

- После подключения (через 2 секунды) студент отправляет запрос `state_request` репетитору
- Репетитор получает запрос и отправляет ответ `state_response` с текущим состоянием
- Студент получает ответ с `mode: 'compact'` и `boardId`
- Студент автоматически переключается на доску в compact mode
- В URL добавляется параметр `?call=<callId>`

**Файлы:**

- `src/hooks/useParticipantJoinSync.ts` - `requestState` (студент), `handleStateRequest` (репетитор)
- `src/hooks/useParticipantJoinSync.ts` - `handleStateResponse` (студент)

---

### 2. Студент заходит в ВКС, когда репетитор НЕ на доске

**Действия:**

1. Студент подключается к ВКС
2. Репетитор в full mode (не на доске)

**Что происходит:**

- После подключения студент отправляет запрос `state_request` репетитору
- Репетитор получает запрос, но не отправляет ответ (так как не в compact mode)
- Студент остается в full mode на странице конференции
- Кнопка "К доске" **НЕ отображается** (так как нет `activeBoardId`)

**Файлы:**

- `src/hooks/useParticipantJoinSync.ts` - `handleStateRequest` (проверка `mode === 'compact'`)
- `src/ui/Bottom/BottomBar.tsx` - условие `showBackToBoardButton`

---

### 3. Студент переключается на full view с доски

**Действия:**

1. Студент на доске в compact mode
2. Нажимает кнопку "Вернуться в конференцию" в `CompactCall`

**Что происходит:**

- Локальный `mode` обновляется на `'full'`
- `activeBoardId` и `activeClassroom` **НЕ очищаются** (для возможности вернуться)
- **Сообщение другим участникам НЕ отправляется** (только репетитор может синхронизировать режим)
- Студент переходит на страницу конференции `/call/<callId>` с параметром `?call=<callId>`
- Репетитор остается на доске (не переключается)

**Файлы:**

- `src/ui/CompactView/CompactCall.tsx` - `handleMaximize` (проверка `isTutor`)
- `src/hooks/useModeSync.ts` - `handleModeSyncMessage` (защита от переключения на full)

---

### 4. Студент возвращается на доску из full view

**Действия:**

1. Студент в full view, но `activeBoardId` и `activeClassroom` сохранены в store
2. Нажимает кнопку "К доске" в `BottomBar`

**Что происходит:**

- Локальный `mode` обновляется на `'compact'`
- Отправляется сообщение `mode_sync` с `mode: 'compact'` и `boardId` всем участникам
- Студент переходит на страницу доски с параметром `?call=<callId>`
- Репетитор получает сообщение, но остается на доске (уже там)

**Файлы:**

- `src/ui/Bottom/BottomBar.tsx` - `handleBackToBoard`
- `src/hooks/useModeSync.ts` - `handleModeSyncMessage`

---

### 5. Студент получает ответ о состоянии после переключения на full

**Проблема (решенная):**

- Студент переключается на full view
- Через секунду получает ответ `state_response` от репетитора (который на доске)
- Студент автоматически переключается обратно на доску

**Решение:**

- В `handleStateResponse` добавлена проверка: если студент в `full` mode и не на доске, ответ игнорируется
- В `requestState` добавлена проверка: не запрашивать состояние, если студент в `full` mode и не на доске

**Файлы:**

- `src/hooks/useParticipantJoinSync.ts` - `handleStateResponse` (проверка `currentMode === 'full'`)
- `src/hooks/useParticipantJoinSync.ts` - `requestState` (проверка перед запросом)

---

### 6. Студент отключается от ВКС

**Действия:**

1. Студент нажимает "Отключиться"

**Что происходит:**

- Очищаются `activeBoardId` и `activeClassroom` в store
- Очищается параметр `call` из URL
- Все состояния интерфейса сбрасываются

**Файлы:**

- `src/providers/LiveKitProvider.tsx` - `handleDisconnect`
- `src/ui/CompactView/CompactView.tsx` - `useEffect` для очистки

---

### 7. Студент подключается к новой ВКС (после предыдущей сессии)

**Проблема (решенная):**

- Студент подключается к новой ВКС
- В store остались старые значения `activeBoardId` и `activeClassroom` от предыдущей сессии
- Кнопка "К доске" отображается некорректно

**Решение:**

- При подключении проверяется соответствие `activeClassroom` текущему `callId`
- Если не совпадает - значения очищаются
- Кнопка показывается только если комната подключена и есть активная доска

**Файлы:**

- `src/providers/LiveKitProvider.tsx` - `handleConnect` (проверка `activeClassroom !== callId`)
- `src/ui/Bottom/BottomBar.tsx` - условие `showBackToBoardButton` (проверка подключения комнаты)

---

## Защитные механизмы

### 1. Защита от переключения на full при нахождении на доске

**Проблема:** Когда один участник переключается на full, другие участники на доске не должны переключаться.

**Решение:**

- В `useModeSync.ts` добавлена проверка: если пользователь на доске (`activeBoardId`), сообщения о переключении на `full` игнорируются
- **Исключение**: Если репетитор выбирает "Всем участникам", то `activeBoardId` очищается перед отправкой сообщения, и все участники переключаются на full

**Файлы:**

- `src/hooks/useModeSync.ts` - `handleModeSyncMessage` (проверка `currentActiveBoardId`)
- `src/ui/CompactView/CompactCall.tsx` - `handleMaximize` (очистка `activeBoardId` при `syncToAll = true`)

---

### 2. Защита от автоматического переключения студента обратно на доску

**Проблема:** Студент переключается на full, но получает ответ от репетитора и переключается обратно.

**Решение:**

- В `handleStateResponse` добавлена проверка: если студент в `full` mode и не на доске, ответ игнорируется
- В `requestState` добавлена проверка: не запрашивать состояние, если студент в `full` mode и не на доске

**Файлы:**

- `src/hooks/useParticipantJoinSync.ts` - `handleStateResponse`
- `src/hooks/useParticipantJoinSync.ts` - `requestState`

---

### 3. Сохранение параметра `call` в URL

**Проблема:** При навигации на доску параметр `call` удаляется, и ВКС отключается.

**Решение:**

- При навигации на доску всегда добавляется параметр `?call=<callId>`
- В `CompactView` добавлена проверка: не очищать параметр `call`, если пользователь на доске и есть `activeClassroom`

**Файлы:**

- `src/ui/CompactView/CompactView.tsx` - `useEffect` для очистки URL
- Все места навигации на доску используют `search: { call: classroomId }`

---

## Типы сообщений DataChannel

### `mode_sync`

- **Отправитель:** Репетитор (при переключении режима)
- **Получатель:** Все участники
- **Payload:**
  ```typescript
  {
    mode: 'compact' | 'full';
    boardId?: string;
    classroom?: string;
  }
  ```
- **Использование:** Синхронизация режима отображения и активной доски

### `state_request`

- **Отправитель:** Студент (при подключении)
- **Получатель:** Репетитор
- **Payload:**
  ```typescript
  {
    participantId: string;
  }
  ```
- **Использование:** Запрос текущего состояния у репетитора

### `state_response`

- **Отправитель:** Репетитор (в ответ на `state_request`)
- **Получатель:** Студент
- **Payload:**
  ```typescript
  {
    mode: 'compact' | 'full';
    boardId?: string;
    classroom?: string;
  }
  ```
- **Использование:** Ответ с текущим состоянием репетитора

---

## Ключевые файлы

- `src/hooks/useModeSync.ts` - Синхронизация режима отображения
- `src/hooks/useParticipantJoinSync.ts` - Синхронизация при подключении новых участников
- `src/ui/Bottom/WhiteboardsModal.tsx` - Модальное окно выбора доски
- `src/ui/CompactView/CompactCall.tsx` - Компактный вид ВКС
- `src/ui/Bottom/BottomBar.tsx` - Нижняя панель управления
- `src/ui/CompactView/CompactView.tsx` - Обертка для compact view
- `src/store/callStore.ts` - Zustand store для состояния ВКС
- `src/providers/LiveKitProvider.tsx` - Провайдер LiveKit

---

## Примечания

1. **Независимость режимов:** Каждый участник может независимо переключаться между `compact` и `full` режимами, но только репетитор может синхронизировать режим с другими участниками.

2. **Сохранение состояния доски:** При переключении на `full` mode информация о доске (`activeBoardId`, `activeClassroom`) не очищается, чтобы пользователь мог вернуться на доску. **Исключение**: Если репетитор выбирает "Всем участникам", состояние доски очищается для всех.

3. **Очистка состояния:** При отключении от ВКС все состояния, включая информацию о доске, очищаются.

4. **Параметр `call` в URL:** Критически важен для поддержания соединения ВКС при навигации на доску. Всегда должен присутствовать в URL при работе с доской.

5. **Dropdown для репетитора:** Репетитор имеет возможность выбрать, переключиться на full view только себе или всем участникам. При выборе "Всем участникам" информация о доске очищается, и все участники переключаются на full view.
