name: On Pull Request (Development)

on:
  pull_request:

jobs:
  namer:
    runs-on: ubuntu-latest

    steps:
      - name: Get branch & deployment name
        id: get_names
        run: |-
          branch_name=${{ github.event.pull_request.head.ref }}
          echo "branch_name=${branch_name}"
          echo "branch_name=${branch_name}" >> $GITHUB_OUTPUT

          deployment_name="${branch_name////-}"
          echo "deployment_name=${deployment_name}"
          echo "deployment_name=${deployment_name}" >> $GITHUB_OUTPUT

    outputs:
      branch_name: ${{ steps.get_names.outputs.branch_name }}
      deployment_name: ${{ steps.get_names.outputs.deployment_name }}

  main:
    needs:
      - namer
    uses: ./.github/workflows/main.yml
    with:
      deployment_name: ${{ needs.namer.outputs.deployment_name }}
      github_environment_name: xi-development
    secrets: inherit

  comment:
    needs:
      - namer
      - main
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Comment about deployment success
        if: needs.main.result == 'success'
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: deployment_status
          message: |
            :white_check_mark: Branch has been successfully deployed!

            [Visit Preview](https://app.xieffect.ru/deployments/${{ needs.namer.outputs.deployment_name }}/enable)

      - name: Comment about deployment failure
        if: needs.main.result == 'failure'
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: deployment_status
          message: |
            :x: Branch deployment failed!
            
            Visit [logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more info
